---
phase: 09-role-visibility-and-enforcement-finalization
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - src/app/router/AppRouter.tsx
  - src/shared/components/ProfileMenu.tsx
  - src/app/router/AppRouter.role-access.test.tsx
  - src/shared/components/ProfileMenu.test.tsx
autonomous: true
requirements: [ROLE-01, ROLE-03]
user_setup: []
must_haves:
  truths:
    - "Direct navigation to unauthorized routes is always redirected to an allowed fallback and shows one short permission hint."
    - "Non-platform-admin users without active account continue to hit the activation flow and are not silently routed into protected app areas."
    - "Header/home profile menus only show admin/owner entries when route access is allowed for the current principal."
  artifacts:
    - path: src/app/router/AppRouter.tsx
      provides: matrix-driven route guard and denied-route redirect hint handling
      min_lines: 420
    - path: src/shared/components/ProfileMenu.tsx
      provides: matrix-driven visibility for admin and owner navigation entries
      min_lines: 90
    - path: src/app/router/AppRouter.role-access.test.tsx
      provides: route deny redirect + hint regressions for role/no-account cases
      min_lines: 90
    - path: src/shared/components/ProfileMenu.test.tsx
      provides: menu visibility regressions tied to route-access contract
      min_lines: 70
  key_links:
    - from: src/app/router/AppRouter.tsx
      to: src/shared/auth/roleAccess.ts
      via: route guard and fallback logic call canonical role helpers
    - from: src/app/router/AppRouter.tsx
      to: src/shared/lib/permissionMessages.ts
      via: denied-route toasts use short generic permission mapping
    - from: src/shared/components/ProfileMenu.tsx
      to: src/shared/auth/roleAccess.ts
      via: menu entry visibility references same route policy as router
---

<objective>
Wire the canonical role matrix into route-level access and navigation entry visibility.

Purpose: Ensure role-based page visibility is enforced consistently at runtime (not only in menu rendering) and meets redirect+hint behavior from locked Phase 9 decisions.
Output: Matrix-driven router guards, matrix-driven profile menu visibility, and regression tests for denied route flows.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-CONTEXT.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-RESEARCH.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-01-SUMMARY.md
@src/app/router/AppRouter.tsx
@src/shared/components/ProfileMenu.tsx
@src/shared/auth/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace ad-hoc route guards with canonical roleAccess helpers in AppRouter</name>
  <files>src/app/router/AppRouter.tsx</files>
  <action>
    Refactor route access checks to compute a normalized principal from auth state and evaluate route access through `roleAccess` helpers.
    Apply helper-based checks to:
    - protected routes (`/adminbereich`, `/owner-bereich`, `/busflow`)
    - alias routes (`/owner-settings`, `/company-settings`, `/team-admin`, `/platform-admin`, `/admin`)
    - deny fallback calculation
    Implement denied-direct-route handling with one short permission toast and redirect to helper-derived fallback.
    Preserve locked behavior: pending-account activation screen remains mandatory for non-platform-admin users without active account.
  </action>
  <verify>
    <automated>npm run typecheck</automated>
  </verify>
  <done>Router no longer relies on scattered inline permission expressions and consistently enforces matrix-defined route access and fallback behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Align profile menu visibility with route access contract</name>
  <files>src/shared/components/ProfileMenu.tsx</files>
  <action>
    Update profile menu logic to show/hide "Adminbereich" and "Owner Bereich" entries using route-access helpers instead of direct role string checks only.
    Keep owner entry constrained to platform-owner principals.
    Ensure no unauthorized menu target remains visible (hide, do not disable).
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint -- src/shared/components/ProfileMenu.tsx</automated>
  </verify>
  <done>Navigation entry visibility is derived from the same role matrix as route guards, preventing UI-route drift.</done>
</task>

<task type="auto">
  <name>Task 3: Add router/menu regressions for denied routes and visibility</name>
  <files>
    src/app/router/AppRouter.role-access.test.tsx
    src/shared/components/ProfileMenu.test.tsx
  </files>
  <action>
    Add test coverage for:
    - dispatch/viewer direct navigation to `/adminbereich` redirects to fallback with short permission hint
    - non-owner direct navigation to `/owner-bereich` uses fallback priority contract
    - non-platform-admin without active account remains in activation flow
    - profile menu hides admin/owner entries for unauthorized principals
    Reuse existing AppRouter test mocking patterns.
  </action>
  <verify>
    <automated>npm run test -- src/app/router/AppRouter.role-access.test.tsx src/shared/components/ProfileMenu.test.tsx</automated>
  </verify>
  <done>ROLE-01 route visibility behavior is regression-locked for real role scenarios and no-account edge cases.</done>
</task>

</tasks>

<verification>
Route access, fallback redirects, and top-level navigation visibility are all enforced through one shared policy and tested against key denied-role scenarios.
</verification>

<success_criteria>
- [ ] Protected routes and aliases use matrix helpers for allow/deny/fallback.
- [ ] Denied direct route navigation shows short permission hint plus redirect.
- [ ] Pending-account flow for non-platform-admin users remains intact.
- [ ] Profile menu hides unauthorized admin/owner entries.
- [ ] New router/menu role-access tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-role-visibility-and-enforcement-finalization/09-02-SUMMARY.md`
</output>
