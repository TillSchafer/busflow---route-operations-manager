---
phase: 09-role-visibility-and-enforcement-finalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/auth/roleAccess.ts
  - src/shared/auth/roleAccess.test.ts
  - src/shared/lib/permissionMessages.ts
  - src/shared/lib/permissionMessages.test.ts
  - docs/architecture/role-action-matrix.md
autonomous: true
requirements: [ROLE-03, ROLE-01]
user_setup: []
must_haves:
  truths:
    - "One typed source of truth defines route access, action access, and redirect fallbacks for platform-admin, account-admin, dispatch, viewer, and no-account states."
    - "Permission-denied UI copy is short and generic, while session/auth errors keep their separate relogin message path."
    - "A documented role-to-route/action matrix exists and matches the runtime helper contract."
  artifacts:
    - path: src/shared/auth/roleAccess.ts
      provides: canonical route/action/fallback authorization matrix and helper functions
      min_lines: 140
    - path: src/shared/lib/permissionMessages.ts
      provides: centralized mapping from permission error codes to short user-safe messages
      min_lines: 50
    - path: docs/architecture/role-action-matrix.md
      provides: canonical ROLE-03 matrix documentation for core flows
      min_lines: 80
    - path: src/shared/auth/roleAccess.test.ts
      provides: contract tests for locked route/action/fallback decisions
      min_lines: 70
  key_links:
    - from: src/shared/auth/roleAccess.ts
      to: docs/architecture/role-action-matrix.md
      via: documented table rows mirror runtime matrix keys and role outcomes
    - from: src/shared/lib/permissionMessages.ts
      to: src/shared/lib/error-mapping.ts
      via: permission mapping composes with existing auth/session error split
    - from: src/shared/auth/roleAccess.test.ts
      to: src/shared/auth/roleAccess.ts
      via: tests lock access/fallback behavior to prevent drift
---

<objective>
Create the canonical Phase 9 role-access contract before feature-specific wiring.

Purpose: Eliminate UI/backend authorization drift by defining one matrix and one permission-message mapping that downstream plans consume.
Output: A typed `roleAccess` module, short generic permission-message resolver, and a maintained role-to-action documentation artifact.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-CONTEXT.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-RESEARCH.md
@src/shared/auth/AuthContext.tsx
@src/app/router/AppRouter.tsx
@src/shared/lib/error-mapping.ts
@docs/architecture/role-model.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement canonical role route/action/fallback matrix</name>
  <files>
    src/shared/auth/roleAccess.ts
    src/shared/auth/roleAccess.test.ts
  </files>
  <action>
    Create `src/shared/auth/roleAccess.ts` with a normalized principal model (platform-admin flag, platform-owner flag, account role, active-account state) and typed helpers:
    - `canAccessRoute(principal, routeId)`
    - `canPerformAction(principal, actionId)`
    - `getDeniedFallback(principal, deniedRouteId)`
    Encode locked decisions from Phase 9:
    - `/adminbereich` only account-admin or platform-admin
    - `/owner-bereich` only platform-owner
    - all account roles share busflow read visibility (no role filter on route data visibility)
    - non-platform-admin without active account is constrained to activation flow
    - denied route fallback priority: adminbereich (if allowed) then `/`, with no-account activation constraint preserved
    Add unit tests covering role matrix rows and fallback behavior.
  </action>
  <verify>
    <automated>npm run test -- src/shared/auth/roleAccess.test.ts</automated>
  </verify>
  <done>Role access and fallback behavior is expressible through a single tested helper contract instead of scattered ad-hoc checks.</done>
</task>

<task type="auto">
  <name>Task 2: Add centralized generic permission-message resolver</name>
  <files>
    src/shared/lib/permissionMessages.ts
    src/shared/lib/permissionMessages.test.ts
  </files>
  <action>
    Create a permission-message helper that maps permission/business-deny codes (`FORBIDDEN`, `USER_SCOPE_VIOLATION`, `SELF_DELETE_FORBIDDEN`, similar deny codes) to one short generic German permission text without exposing internals.
    Keep auth/session errors explicitly separate by preserving `FunctionAuthError` handling via existing `error-mapping` behavior.
    Add tests for mapped deny codes, unknown-code fallback, and non-regression for session error message behavior.
  </action>
  <verify>
    <automated>npm run test -- src/shared/lib/permissionMessages.test.ts</automated>
  </verify>
  <done>Permission-denied UI messaging is consistent, concise, and separated from auth/session expiry handling.</done>
</task>

<task type="auto">
  <name>Task 3: Publish canonical role-to-action matrix documentation</name>
  <files>docs/architecture/role-action-matrix.md</files>
  <action>
    Add/update `docs/architecture/role-action-matrix.md` with:
    - route access matrix for `/`, `/busflow`, `/profile`, `/adminbereich`, `/owner-bereich`, and no-account activation state
    - action matrix for membership-role change, invitation send/resend/delete, user hard-delete, busflow write actions, busflow read actions
    - explicit "hide vs disable" policy list for unauthorized controls in Phase 9
    - fallback redirect order and short denied-message policy
    Ensure terminology aligns with `docs/architecture/role-model.md`.
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint</automated>
  </verify>
  <done>ROLE-03 has a maintained, project-local matrix artifact aligned to runtime helper contracts and locked phase decisions.</done>
</task>

</tasks>

<verification>
Canonical role matrix and permission-message policy exist as code + tests + documentation and can be consumed by all downstream Phase 9 enforcement plans.
</verification>

<success_criteria>
- [ ] A single typed `roleAccess` module defines route, action, and fallback policy.
- [ ] Permission-denied responses map to short generic text without leaking internals.
- [ ] Session/auth expiry message path remains distinct from permission denies.
- [ ] `docs/architecture/role-action-matrix.md` exists and matches helper behavior.
- [ ] New role/messaging tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-role-visibility-and-enforcement-finalization/09-01-SUMMARY.md`
</output>
