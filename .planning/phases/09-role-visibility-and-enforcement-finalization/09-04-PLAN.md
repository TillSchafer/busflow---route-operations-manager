---
phase: 09-role-visibility-and-enforcement-finalization
plan: 04
type: execute
wave: 2
depends_on: [01]
files_modified:
  - supabase/functions/admin-delete-user-v3/index.ts
  - scripts/supabase/e2e-functions-auth-matrix.mjs
  - .planning/phases/09-role-visibility-and-enforcement-finalization/09-ROLE-ENFORCEMENT-TRACEABILITY.md
autonomous: true
requirements: [ROLE-02, ROLE-03]
user_setup: []
must_haves:
  truths:
    - "User hard-delete is rejected server-side for every non-platform-admin role, including manipulated clients."
    - "Role auth-matrix verification includes explicit allow/deny cases for hard-delete and invitation-management functions."
    - "ROLE-02/ROLE-03 server-enforcement evidence is documented with executable verification commands and expected outcomes."
  artifacts:
    - path: supabase/functions/admin-delete-user-v3/index.ts
      provides: platform-admin-only authorization gate for hard-delete endpoint
      min_lines: 220
    - path: scripts/supabase/e2e-functions-auth-matrix.mjs
      provides: staging auth matrix cases for hard-delete and invitation mutation authorization
      min_lines: 260
    - path: .planning/phases/09-role-visibility-and-enforcement-finalization/09-ROLE-ENFORCEMENT-TRACEABILITY.md
      provides: requirement-to-test mapping and evidence checklist for ROLE-02/ROLE-03
      min_lines: 70
  key_links:
    - from: supabase/functions/admin-delete-user-v3/index.ts
      to: scripts/supabase/e2e-functions-auth-matrix.mjs
      via: matrix test cases assert platform-admin allow and non-admin deny behavior
    - from: scripts/supabase/e2e-functions-auth-matrix.mjs
      to: .planning/phases/09-role-visibility-and-enforcement-finalization/09-ROLE-ENFORCEMENT-TRACEABILITY.md
      via: traceability artifact documents command usage, payload env vars, and expected status envelopes
---

<objective>
Finalize server-side role enforcement and verification evidence for privileged mutations.

Purpose: Guarantee ROLE-02 is enforced beyond UI controls and close ROLE-03 with auditable server authorization evidence.
Output: Platform-admin-only hard-delete enforcement, expanded auth-matrix test script coverage, and a phase-local traceability artifact.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-CONTEXT.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-RESEARCH.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-01-SUMMARY.md
@supabase/functions/admin-delete-user-v3/index.ts
@supabase/functions/admin-update-membership-role-v1/index.ts
@supabase/functions/admin-manage-invitation-v1/index.ts
@supabase/functions/invite-account-user/index.ts
@scripts/supabase/e2e-functions-auth-matrix.mjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restrict `admin-delete-user-v3` to platform-admin callers only</name>
  <files>supabase/functions/admin-delete-user-v3/index.ts</files>
  <action>
    Remove account-admin authorization path for hard-delete and enforce a strict platform-admin gate.
    Behavior requirements:
    - caller must resolve to `profiles.global_role = ADMIN`, otherwise return forbidden
    - self-delete and last-platform-admin protections remain intact
    - account scoping and audit metadata continue to function for platform-admin calls
    Keep error shapes concise and consistent with existing function patterns.
  </action>
  <verify>
    <automated>npm run lint && npm run typecheck</automated>
  </verify>
  <done>Hard-delete endpoint blocks all non-platform-admin callers server-side, including manipulated client requests.</done>
</task>

<task type="auto">
  <name>Task 2: Extend staged function auth-matrix coverage for Phase 9 role enforcement</name>
  <files>scripts/supabase/e2e-functions-auth-matrix.mjs</files>
  <action>
    Expand matrix cases to include:
    - `admin-delete-user-v3`: platform-admin allow, account-admin/dispatch/viewer forbid envelope
    - invitation mutation coverage (`invite-account-user`, `admin-manage-invitation-v1`) for allowed admin roles and denied viewer role
    Add payload-env wiring for new mutation cases (document expected env variable names in script comments or report output metadata).
    Keep `E2E_ALLOW_MUTATIONS` safety behavior unchanged.
  </action>
  <verify>
    <automated>node --check scripts/supabase/e2e-functions-auth-matrix.mjs</automated>
  </verify>
  <done>Auth-matrix script can exercise Phase 9 privileged mutation allow/deny expectations with explicit role cases.</done>
</task>

<task type="auto">
  <name>Task 3: Create ROLE-02/ROLE-03 enforcement traceability artifact</name>
  <files>.planning/phases/09-role-visibility-and-enforcement-finalization/09-ROLE-ENFORCEMENT-TRACEABILITY.md</files>
  <action>
    Create a phase-local traceability document that maps:
    - ROLE-02 server-enforcement claims to edge function behavior and auth-matrix test IDs
    - ROLE-03 matrix verification claims to matrix docs/tests/scripts and expected status outcomes
    Include one execution section with exact commands for local static checks and staging auth-matrix execution, plus evidence placeholders for execution output links.
  </action>
  <verify>
    <automated>rg -n \"ROLE-02|ROLE-03|admin-delete-user-v3|e2e-functions-auth-matrix\" .planning/phases/09-role-visibility-and-enforcement-finalization/09-ROLE-ENFORCEMENT-TRACEABILITY.md</automated>
  </verify>
  <done>Phase 9 has an auditable requirement-to-enforcement/test mapping artifact that can be attached to verification reports.</done>
</task>

</tasks>

<verification>
Server-side authorization is hardened for hard-delete and backed by reproducible auth-matrix checks with explicit ROLE-02/ROLE-03 traceability.
</verification>

<success_criteria>
- [ ] `admin-delete-user-v3` enforces platform-admin-only caller policy.
- [ ] Auth-matrix script contains explicit allow/deny cases for hard-delete and invitation admin mutations.
- [ ] Traceability doc maps ROLE-02/ROLE-03 to concrete code paths and verification commands.
- [ ] Static checks for modified script/function files pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-role-visibility-and-enforcement-finalization/09-04-SUMMARY.md`
</output>
