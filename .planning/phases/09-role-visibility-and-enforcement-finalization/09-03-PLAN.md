---
phase: 09-role-visibility-and-enforcement-finalization
plan: 03
type: execute
wave: 2
depends_on: [01]
files_modified:
  - src/features/admin/team/pages/TeamAdminPage.tsx
  - src/shared/api/admin/teamAdmin.api.ts
  - src/apps/busflow/BusflowApp.tsx
  - src/apps/busflow/components/RouteList.tsx
  - src/features/admin/team/pages/TeamAdminPage.role-access.test.tsx
  - src/apps/busflow/components/RouteList.role-access.test.tsx
autonomous: true
requirements: [ROLE-01, ROLE-02]
user_setup: []
must_haves:
  truths:
    - "Unauthorized role-based actions are hidden in UI controls (not shown as disabled controls) in Phase 9 core flows."
    - "User hard-delete controls are visible only for platform-admin principals even inside TeamAdmin."
    - "Permission-denied mutation responses show short generic permission messages while session/auth failures keep dedicated relogin messaging."
  artifacts:
    - path: src/features/admin/team/pages/TeamAdminPage.tsx
      provides: role-aware control visibility and normalized permission-error toast behavior
      min_lines: 500
    - path: src/shared/api/admin/teamAdmin.api.ts
      provides: stable error-code propagation for admin mutation deny handling
      min_lines: 170
    - path: src/apps/busflow/BusflowApp.tsx
      provides: hidden viewer write controls for route creation and settings entry points
      min_lines: 620
    - path: src/apps/busflow/components/RouteList.tsx
      provides: hidden viewer edit/delete controls with read-only actions retained
      min_lines: 170
  key_links:
    - from: src/features/admin/team/pages/TeamAdminPage.tsx
      to: src/shared/lib/permissionMessages.ts
      via: denied mutation codes map to one short generic permission text set
    - from: src/shared/api/admin/teamAdmin.api.ts
      to: src/features/admin/team/pages/TeamAdminPage.tsx
      via: API preserves actionable error codes so UI can distinguish deny vs auth paths
    - from: src/apps/busflow/BusflowApp.tsx
      to: src/apps/busflow/components/RouteList.tsx
      via: write-control visibility policy is consistently enforced at parent and row-action levels
---

<objective>
Finalize action-control visibility behavior for role enforcement in TeamAdmin and BusFlow.

Purpose: Close the remaining Phase 9 UI drift by enforcing "hide, not disable" for unauthorized actions and by normalizing deny feedback paths for mutation errors.
Output: Role-correct visibility for hard-delete and BusFlow write actions, plus regression tests for hidden controls and deny messaging.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-CONTEXT.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-RESEARCH.md
@.planning/phases/09-role-visibility-and-enforcement-finalization/09-01-SUMMARY.md
@src/features/admin/team/pages/TeamAdminPage.tsx
@src/shared/api/admin/teamAdmin.api.ts
@src/apps/busflow/BusflowApp.tsx
@src/apps/busflow/components/RouteList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce TeamAdmin control visibility and deny-message normalization</name>
  <files>
    src/features/admin/team/pages/TeamAdminPage.tsx
    src/shared/api/admin/teamAdmin.api.ts
  </files>
  <action>
    Update TeamAdmin behavior to align with locked decisions:
    - show user hard-delete affordance only for platform-admin users
    - keep invite and membership-role actions for account-admin + platform-admin
    - keep account-status disabled states only for non-role reasons (archived/suspended account), not for unauthorized role hiding
    Ensure `TeamAdminApi.deleteUserHard` preserves backend error codes (not only plain text) so UI can map permission denies to centralized short generic permission text.
    Keep session/auth error handling separate from permission errors.
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint -- src/features/admin/team/pages/TeamAdminPage.tsx src/shared/api/admin/teamAdmin.api.ts</automated>
  </verify>
  <done>TeamAdmin actions follow role visibility policy, and deny responses use stable generic permission copy without internal details.</done>
</task>

<task type="auto">
  <name>Task 2: Hide BusFlow write controls for read-only roles</name>
  <files>
    src/apps/busflow/BusflowApp.tsx
    src/apps/busflow/components/RouteList.tsx
  </files>
  <action>
    Replace role-denied disabled controls with hidden controls for viewer/read-only principals:
    - hide "Route erstellen" when write access is denied
    - hide edit/delete actions in route cards when write access is denied
    - preserve read actions (print/export, list visibility)
    Keep existing backend/API write guards as defense-in-depth and keep existing "Keine Berechtigung" toasts for manipulated client paths.
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint -- src/apps/busflow/BusflowApp.tsx src/apps/busflow/components/RouteList.tsx</automated>
  </verify>
  <done>Viewer/read-only users only see allowed read actions while write controls are not rendered.</done>
</task>

<task type="auto">
  <name>Task 3: Add role-visibility regression tests for TeamAdmin and BusFlow controls</name>
  <files>
    src/features/admin/team/pages/TeamAdminPage.role-access.test.tsx
    src/apps/busflow/components/RouteList.role-access.test.tsx
  </files>
  <action>
    Add tests that verify:
    - hard-delete control is absent for account-admin and present for platform-admin
    - role-denied backend error codes map to generic permission toast copy
    - BusFlow viewer mode does not render create/edit/delete controls
    - BusFlow read affordances remain visible in viewer mode
    Use focused component tests with mocked handlers and role props.
  </action>
  <verify>
    <automated>npm run test -- src/features/admin/team/pages/TeamAdminPage.role-access.test.tsx src/apps/busflow/components/RouteList.role-access.test.tsx</automated>
  </verify>
  <done>ROLE-01 visibility rules and UI deny behavior are protected by regression tests in both admin and busflow surfaces.</done>
</task>

</tasks>

<verification>
Core action controls now obey role visibility policy end-to-end in UI surfaces while preserving separate auth-vs-permission error handling.
</verification>

<success_criteria>
- [ ] TeamAdmin hard-delete controls are platform-admin-only.
- [ ] Unauthorized actions are hidden, not role-disabled controls.
- [ ] BusFlow viewer mode shows read actions but hides create/edit/delete controls.
- [ ] Permission-denied toasts are short and generic; auth/session messages remain separate.
- [ ] New TeamAdmin and RouteList role-access tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/09-role-visibility-and-enforcement-finalization/09-03-SUMMARY.md`
</output>
