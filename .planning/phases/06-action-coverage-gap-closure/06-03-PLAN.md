---
phase: 06-action-coverage-gap-closure
plan: 03
type: execute
wave: 3
depends_on: [01, 02]
gap_closure: true
files_modified:
  - src/apps/busflow/BusflowApp.tsx
  - src/apps/busflow/components/settings/CustomerManagementPanel.tsx
  - src/shared/loading/LoadingProvider.test.tsx
  - src/shared/loading/FullPageLoadingScreen.test.tsx
  - .planning/phases/06-action-coverage-gap-closure/06-ASYNC-FLOW-INVENTORY.md
autonomous: true
requirements: [FLOW-03, FLOW-04, QUAL-03]
user_setup: []
must_haves:
  truths:
    - "BusFlow critical mutations (save/delete/settings/import/bulk-delete/map-default) trigger shared action loading with explicit keys."
    - "Long-running import/delete flows keep both global full-page loader and progress viewport visible while reporting progress."
    - "Concurrency behavior is regression-checked so loader visibility remains active until all overlapping actions settle."
    - "Async flow inventory reaches `Verified` status for Phase 6 in-scope user-triggered flows with test/manual evidence links."
  artifacts:
    - path: src/apps/busflow/BusflowApp.tsx
      provides: busflow mutation handlers wired to mandatory action wrapper and long-running loading token updates
      min_lines: 420
    - path: src/apps/busflow/components/settings/CustomerManagementPanel.tsx
      provides: import and bulk-delete progress callbacks remain aligned with global loading behavior
      min_lines: 420
    - path: src/shared/loading/LoadingProvider.test.tsx
      provides: overlap lifecycle regression coverage for action concurrency semantics
      min_lines: 100
    - path: .planning/phases/06-action-coverage-gap-closure/06-ASYNC-FLOW-INVENTORY.md
      provides: final phase coverage and verification evidence table
      min_lines: 70
  key_links:
    - from: src/apps/busflow/BusflowApp.tsx
      to: src/shared/loading/useActionLoading.ts
      via: busflow mutation handlers route through shared mandatory wrapper with explicit action keys
    - from: src/apps/busflow/BusflowApp.tsx
      to: src/apps/busflow/components/settings/CustomerManagementPanel.tsx
      via: import/bulk-delete progress callbacks synchronize with global action loading lifecycle
    - from: src/shared/loading/LoadingProvider.test.tsx
      to: src/shared/loading/loading-engine.ts
      via: tests assert concurrent token behavior keeps visibility accurate until all actions settle
---

<objective>
Complete BusFlow action wiring and close Phase 6 verification/inventory gaps for concurrency and long-running progress coexistence.

Purpose: Finish FLOW-03/FLOW-04 rollout in the largest mutation surface and produce auditable QUAL-03 verification evidence.
Output: BusFlow mutation wiring, coexistence-safe import/delete behavior, concurrency regressions, and inventory promotion to `Verified`.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-action-coverage-gap-closure/06-CONTEXT.md
@.planning/phases/06-action-coverage-gap-closure/06-RESEARCH.md
@.planning/phases/06-action-coverage-gap-closure/06-01-SUMMARY.md
@.planning/phases/06-action-coverage-gap-closure/06-02-SUMMARY.md
@src/apps/busflow/BusflowApp.tsx
@src/apps/busflow/components/settings/CustomerManagementPanel.tsx
@src/shared/loading/LoadingProvider.test.tsx
@src/shared/loading/FullPageLoadingScreen.test.tsx
@.planning/phases/06-action-coverage-gap-closure/06-ASYNC-FLOW-INVENTORY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire BusFlow mutation handlers to shared action loading and explicit keys</name>
  <files>
    src/apps/busflow/BusflowApp.tsx
    .planning/phases/06-action-coverage-gap-closure/06-ASYNC-FLOW-INVENTORY.md
  </files>
  <action>
    Integrate `useActionLoading` across in-scope BusFlow mutation handlers:
    - route save/delete
    - bus type and worker create/delete
    - customer contact create/update/delete
    - customer import commit
    - customer bulk delete
    - map default save
    Keep existing authorization guards and toast copy.
    For long-running import/delete flows, preserve detailed progress callbacks while ensuring global action loading remains active for full operation lifetime.
    Update corresponding inventory rows in the same change to `Covered` with file/handler evidence.
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint -- src/apps/busflow/BusflowApp.tsx</automated>
  </verify>
  <done>All critical BusFlow mutation flows participate in shared action-loading lifecycle and are inventory-tracked.</done>
</task>

<task type="auto">
  <name>Task 2: Align CustomerManagementPanel progress behavior with global loading coexistence</name>
  <files>
    src/apps/busflow/components/settings/CustomerManagementPanel.tsx
    src/shared/loading/FullPageLoadingScreen.test.tsx
  </files>
  <action>
    Adjust import/bulk-delete progress integration points as needed so progress viewport remains meaningful while action loader is active.
    Add/extend loader UI tests to verify coexistence expectations for long-running action scope with progress updates.
    Keep existing progress provider semantics (`startProgress`, `updateProgress`, `finishProgress`) intact.
  </action>
  <verify>
    <automated>npm run test -- src/shared/loading/FullPageLoadingScreen.test.tsx</automated>
  </verify>
  <done>Long-running import/delete actions visibly preserve both global loading and progress detail signals.</done>
</task>

<task type="auto">
  <name>Task 3: Add overlap regression checks and promote inventory statuses to Verified</name>
  <files>
    src/shared/loading/LoadingProvider.test.tsx
    .planning/phases/06-action-coverage-gap-closure/06-ASYNC-FLOW-INVENTORY.md
  </files>
  <action>
    Extend loading provider tests with an overlap scenario where one action fails while another remains active, validating loader visibility and cleanup only after final settle.
    Update Phase 6 inventory statuses from `Covered` to `Verified` for completed flows, attaching evidence pointers (test file and/or manual validation notes) per row.
    Ensure no in-scope critical flow remains `Not covered` by end of Phase 6.
  </action>
  <verify>
    <automated>npm run test -- src/shared/loading/LoadingProvider.test.tsx && npm run check</automated>
  </verify>
  <done>Concurrency and coverage claims are regression-backed and inventory-confirmed for audit closure.</done>
</task>

</tasks>

<verification>
BusFlow action coverage, long-running coexistence, and audit-ready inventory verification are complete.
</verification>

<success_criteria>
- [ ] BusFlow save/delete/settings/import/bulk-delete flows use shared action wrapper with explicit keys.
- [ ] Import and bulk delete keep progress viewport and full-page loader concurrently observable.
- [ ] Loading overlap regression covers failure + concurrent action settle behavior.
- [ ] Phase 6 inventory marks all in-scope critical flows as `Verified` with evidence references.
</success_criteria>

<output>
After completion, create `.planning/phases/06-action-coverage-gap-closure/06-03-SUMMARY.md`
</output>
