---
phase: 02-messaging-route-auth-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/loading/loading-types.ts
  - src/shared/loading/loading-messages.ts
  - src/shared/loading/loading-engine.ts
  - src/shared/loading/index.ts
  - src/shared/loading/loading-messages.test.ts
autonomous: true
requirements: [LOAD-03]
user_setup: []
must_haves:
  truths:
    - "Loading system supports key-based scoped messages with `Lade...` fallback when no key/message is resolved."
    - "Existing explicit message usage remains compatible and wins over registry defaults."
  artifacts:
    - path: src/shared/loading/loading-messages.ts
      provides: central scoped loading message registry and resolver
      min_lines: 40
    - path: src/shared/loading/loading-engine.ts
      provides: resolver integration in display state derivation
      min_lines: 160
    - path: src/shared/loading/loading-messages.test.ts
      provides: resolver fallback/override contract coverage
      min_lines: 40
  key_links:
    - from: src/shared/loading/loading-engine.ts
      to: src/shared/loading/loading-messages.ts
      via: engine resolves final display message through scoped registry policy
---

<objective>
Add scoped loading message registry with deterministic fallback policy.

Purpose: Standardize loading copy behavior so route/auth/action flows can use message keys while always falling back to `Lade...`.
Output: message resolver module integrated into loading engine and regression-tested.
</objective>

<execution_context>
@/Users/tillschafer/.codex/get-shit-done/workflows/execute-plan.md
@/Users/tillschafer/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/shared/loading/loading-types.ts
@src/shared/loading/loading-engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introduce scoped loading message resolver</name>
  <files>
    src/shared/loading/loading-types.ts
    src/shared/loading/loading-messages.ts
    src/shared/loading/index.ts
  </files>
  <action>
    Add typed message-key support to loading start/update payloads and implement a centralized resolver that:
    - accepts scope + optional explicit message + optional messageKey
    - returns explicit message when provided
    - otherwise resolves scoped messageKey from registry
    - falls back to `Lade...` when unresolved
    Keep API backwards-compatible for existing callers that only send `message`.
  </action>
  <verify>
    <automated>npm run typecheck</automated>
  </verify>
  <done>Loading APIs support message keys and expose resolver via shared loading exports.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate resolver into loading engine display state</name>
  <files>src/shared/loading/loading-engine.ts</files>
  <action>
    Update loading engine internals to store optional message keys and derive final display message through resolver policy.
    Ensure `update(token, patch)` can update message key paths without breaking current lifecycle behavior.
  </action>
  <verify>
    <automated>npm run typecheck && npm run lint</automated>
  </verify>
  <done>Display state always emits scoped message policy output with stable fallback behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Add resolver contract tests</name>
  <files>src/shared/loading/loading-messages.test.ts</files>
  <action>
    Add unit tests validating:
    - explicit message takes precedence
    - scoped message key resolves correctly
    - unknown keys and empty values fall back to `Lade...`
  </action>
  <verify>
    <automated>npm run test -- src/shared/loading/loading-messages.test.ts</automated>
  </verify>
  <done>Resolver behavior is locked with regression tests.</done>
</task>

</tasks>

<verification>
Scoped loading message policy exists and is enforced by the loading engine with fallback guarantees.
</verification>

<success_criteria>
- [ ] Message-key policy implemented and typed.
- [ ] Engine emits resolved/fallback message correctly.
- [ ] Resolver tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/02-messaging-route-auth-integration/02-01-SUMMARY.md`
</output>
